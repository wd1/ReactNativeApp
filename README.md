# Tuna Mobile Application

A React Native app designed to provide a CMS managed menu and a newsfeed.

The content used by the app is generated from a JSON feed which is cached on the app. Currently the JSON feed is generated by a view in Drupal which outputs specific content as JSON. The app is built to expand with additional modules such as the "Time to Breath" tool which is a breathing timer, and the "Scrapbook" which enables users to save content and personal notes to the app for future reference.

The scrapbook functions will be accessible by other apps which may share to it from the native device app sharing functionality. For example the user may save an image or song to their scrapbook and store it with their comment about it.

An "Activities" section on the app use a web browser to access the online quiz, assessment and activities section included content which is provided for by the main website.

The app includes "Company" content which is also fed into the app by a JSON feed and which includes the companies GPS data. This GPS data is to be used as part of an app based mapping system which will use the users location to order the services presented.

In the future our goal is to develop more modular based functionality which will extend the range of functions made available by the app, to send user data back to the website, provide secure login functionality as well as payment facilities and which will all be managed from a Drupal CMS.

This project was bootstrapped with [Create React Native App](https://github.com/react-community/create-react-native-app).

Below you'll find information about performing common tasks. The most recent version of this guide is available [here](https://github.com/react-community/create-react-native-app/blob/master/react-native-scripts/template/README.md).

## Table of Contents

* [Updating to New Releases](#updating-to-new-releases)
* [Available Scripts](#available-scripts)
  * [yarn start](#yarn-start)
  * [yarn test](#yarn-test)
  * [yarn run ios](#yarn-run-ios)
  * [yarn run android](#yarn-run-android)
  * [yarn run eject](#yarn-run-eject)
* [Writing and Running Tests](#writing-and-running-tests)
* [Branching](#branching)
* [Environment Variables](#environment-variables)
  * [Configuring Packager IP Address](#configuring-packager-ip-address)
* [Flow](#flow)
* [Customizing App Display Name and Icon](#customizing-app-display-name-and-icon)
* [Publishing the app](#publishing-the-app)
* [Troubleshooting](#troubleshooting)
  * [Networking](#networking)
  * [iOS Simulator won't open](#ios-simulator-wont-open)
  * [QR Code does not scan](#qr-code-does-not-scan)

## Installation

* Download the repo
* Make sure you have node installed
* Make sure you have yarn installed globally via `npm i yarn -g`
* Install the npm dependencies by running `yarn` in the project folder

## Updating to New Releases

Updating the `react-native-scripts` dependency of your app should be as simple as bumping the version number in `package.json` and reinstalling your project's dependencies.

Upgrading to a new version of React Native requires updating the `react-native`, `react`, and `expo` package versions, and setting the correct `sdkVersion` in `app.json`. See the [versioning guide](https://github.com/react-community/create-react-native-app/blob/master/VERSIONS.md) for up-to-date information about package version compatibility.

## Available Scripts

### `yarn start`

Runs your app in development mode.

Open it in the [Expo app](https://expo.io) on your phone to view it. It will reload if you save edits to your files, and you will see build errors and logs in the terminal.

Sometimes you may need to reset or clear the React Native packager's cache. To do so, you can pass the `--reset-cache` flag to the start script:

```
yarn start -- --reset-cache
```

#### `yarn test`

Runs the following tests:

* eslint, for validating the code styling and for basic errors
* [jest](https://github.com/facebook/jest) for your unit tests
* flow, this add and checks typesetting in JavaScript files
* jsdoc, this validates your jsdoc comments and will build the docs as a static website in ~/docs/index.html

You can run the test commands separately as well with the following:

* `yarn run test:lint` - eslint
* `yarn run test:jest` - jest
* `yarn run flow` - flow
* `yarn run jsdoc` - To run jsdoc

You can run jest in watch mode, which will run jest on any file you change, as long as it has a test associated with it. Do this with `yarn run test:watch`.

There is also a prettify command, that runs prettier, which will automatically format the files to fit with eslint, where possible `yarn run prettify`.

#### `yarn run ios`

Like `yarn start`, but also attempts to open your app in the iOS Simulator if you're on a Mac and have it installed.

#### `yarn run android`

Like `yarn start`, but also attempts to open your app on a connected Android device or emulator. Requires an installation of Android build tools (see [React Native docs](https://facebook.github.io/react-native/docs/getting-started.html) for detailed setup). We also recommend installing Genymotion as your Android emulator. Once you've finished setting up the native build environment, there are two options for making the right copy of `adb` available to Create React Native App:

##### Using Android Studio's `adb`

1. Make sure that you can run adb from your terminal.
2. Open Genymotion and navigate to `Settings -> ADB`. Select “Use custom Android SDK tools” and update with your [Android SDK directory](https://stackoverflow.com/questions/25176594/android-sdk-location).

##### Using Genymotion's `adb`

1. Find Genymotion’s copy of adb. On macOS for example, this is normally `/Applications/Genymotion.app/Contents/MacOS/tools/`.
2. Add the Genymotion tools directory to your path (instructions for [Mac](http://osxdaily.com/2014/08/14/add-new-path-to-path-command-line/), [Linux](http://www.computerhope.com/issues/ch001647.htm), and [Windows](https://www.howtogeek.com/118594/how-to-edit-your-system-path-for-easy-command-line-access/)).
3. Make sure that you can run adb from your terminal.

#### `yarn run eject`

This will start the process of "ejecting" from Create React Native App's build scripts. You'll be asked a couple of questions about how you'd like to build your project. Use this if you need to do customisations not possible within Create React Native App. Ideally you won't need to use this, as you will complicate the project and the setup, but sometimes it can't be avoided.

**Warning:** Running eject is a permanent action (aside from whatever version control system you use). An ejected app will require you to have an [Xcode and/or Android Studio environment](https://facebook.github.io/react-native/docs/getting-started.html) set up.

## Customizing App Display Name and Icon

You can edit `app.json` to include [configuration keys](https://docs.expo.io/versions/latest/guides/configuration.html) under the `expo` key.

To change your app's display name, set the `expo.name` key in `app.json` to an appropriate string.

To set an app icon, set the `expo.icon` key in `app.json` to be either a local path or a URL. It's recommended that you use a 512x512 png file with transparency.

## Writing and Running Tests

This project is set up to use [jest](https://facebook.github.io/jest/) for tests. You can configure whatever testing strategy you like, but jest works out of the box. Create test files in directories called `__tests__` at the same level as the file being tested. e.g:

* ~/src/components/DummyComponent/index.js
* ~/src/components/DummyComponent/\_\_tests\_\_/index.js
* ~/src/actions/exampleAction.js
* ~/src/actions/\_\_tests\_\_/exampleAction.js

When you run the jest tests with `yarn run test:jest` it will also create a coverage report at `~/coverage/Icov-report/index.html` that shows you how much of the code is covered and highlights what needs testing. This only provides a report for src files that have an associated test with them, or files included from a file with a test.

If you are using jest snapshots, you can update all snapshots with `yarn run test:jestupdate`.

See the [the template project](https://github.com/react-community/create-react-native-app/blob/master/react-native-scripts/template/App.test.js) for an example test. The [jest documentation](https://facebook.github.io/jest/docs/en/getting-started.html) is also a wonderful resource, as is the [React Native testing tutorial](https://facebook.github.io/jest/docs/en/tutorial-react-native.html).

## Branching

This project follows [git-flow](https://www.atlassian.com/git/tutorials/comparing-workflows/gitflow-workflow) for branching. Please familiarise yourself with it and stick to it.

## Environment Variables

You can configure some of Create React Native App's behavior using environment variables.

### Configuring Packager IP Address

When starting your project, you'll see something like this for your project URL:

```
exp://192.168.0.2:19000
```

The "manifest" at that URL tells the Expo app how to retrieve and load your app's JavaScript bundle, so even if you load it in the app via a URL like `exp://localhost:19000`, the Expo client app will still try to retrieve your app at the IP address that the start script provides.

In some cases, this is less than ideal. This might be the case if you need to run your project inside of a virtual machine and you have to access the packager via a different IP address than the one which prints by default. In order to override the IP address or hostname that is detected by Create React Native App, you can specify your own hostname via the `REACT_NATIVE_PACKAGER_HOSTNAME` environment variable:

Mac and Linux:

```
REACT_NATIVE_PACKAGER_HOSTNAME='my-custom-ip-address-or-hostname' yarn start
```

Windows:

```
set REACT_NATIVE_PACKAGER_HOSTNAME='my-custom-ip-address-or-hostname'
yarn start
```

The above example would cause the development server to listen on `exp://my-custom-ip-address-or-hostname:19000`.

## Flow

Flow is a static type checker that helps you write code with fewer bugs. Check out this [introduction to using static types in JavaScript](https://medium.com/@preethikasireddy/why-use-static-types-in-javascript-part-1-8382da1e0adb) if you are new to this concept.

Any file with `// @flow` at the top of the file will be checked by flow. Run `yarn run flow` to run flow.

To learn more about Flow, check out [its documentation](https://flow.org/).

## Folder/File Structure

* ~ - Project Root, files at this level are config
  * assets - Assets to be used for building the apps
    * icons - Icon assets for the builds
  * scripts - Utility and dev scripts
  * src - For all source code
    * actions - Stores all redux actions
    * components - All React components go in here
      * ComponentName - The name of the component in PascalCase
        * index.js - The main entry file for the React component, normally just exports one of the ComponentName.\*.js files. For simple components will contain all logic
        * ComponentName.container.js - Container component for the component, normally a redux container, probably doesn;t use react at all, will pass props to component.js or render.js
        * ComponentName.component.js - Component that handles the business logic and state for the component, does not render any markup, passes props to render.js instead
        * ComponentName.render.js - Handles all the markup for the component, no state, no complex logic, just loops and if/else
        * style.js - Exports the styles for the component
        * helpers - helper functions specific to this component only
      * ComponentGroupName - The name of a group of components that should be nested under here e.g. FormElements, in PascalCase.
        * ComponentName1 - Follows the contents of ComponentName as above
        * ComponentName2 - Follows the contents of ComponentName as above
        * helpers - helper functions specific to this group of components only
    * constants - Files that store enums, like colour hexes etc.
    * helpers - Helper functions that get used across multiple folders
    * modules - Classes for backendy functionality e.g. api integration
    * reducers - Redux reducers
    * sagas - redux-saga functions
    * store - Redux store configuration
    * types - Generic jsdoc and flow types that get used across files go in here

## Redux and state management

[Redux](https://github.com/reactjs/redux) is being used for the state management of this application. The redux state is also being persisted by [redux-persist](https://github.com/rt2zz/redux-persist/). Which will save the redux state to the async storage as it changes, and then load it back in when the application is open again. This allows you to store specific pieces of the state across sessions. You can add a blacklist to redux-persist to only store some of the state as necessary.

[redux-sagas](https://github.com/redux-saga/redux-saga) is also used here to handle async actions. If you're not familiar please read up on it. It allows you to make async requests when an action get's dispatched, and when the async response returns another action will get dispatched, either a success or error depending on the result. It is a great way to manage async actions with redux.

When writing the reducers for redux please use the [immutable library](https://facebook.github.io/immutable-js/) to store the state, this will dramatically improve the apps performance as it grows and gets more complicated.

## Publishing the app

There are 2 main ways to publish. Publish to expo, which bundles the JS and serves it from Expo's servers, the next time someone opens the app, the new bundle will be downloaded and served without the app requiring an update from the App Store or Google Play.

The other way is to publish the app to the App Store or Google Play. This is mainly to be used when the version of the expo SDK has changed, which requires an App Store/Google Play submission. This way takes much longer to build, and upload the bundle to the App Store/Google Play. And then you have to get it approved in the App Store which could take a while. The benefit with this way is that the actually app is fully updated, so when a user downloads it from the App Store/Google Play it has all the latest code and doesn't require an internet connection to pull the latest from expo. This is also the only way to have a change log in the App Store/Google Play. Unless you put it in the app description. In an ideal world all updates would be done this official way but it just takes too damn long.

### Global setup

You will need to have node installed and have run yarn to install all packages. You also have to have the packager running as an additional process. This is started automatically if you have run `yarn start`

You will also need to have an account with expo and be logged in. Which you can do with:

```
yarn login:expo
```

### Expo - Publishing src changes only

For changes that don't include expo updates runt the following to update for both iOS and Android.

```
yarn run publish
```

#### Seeing the changes

When the publish command has been run, you can then open the corresponding app, the bundle may download in the background, in which case you won't see changes until the second time you open the app. You may need to force close the app, if you want to see these changes straight away.

### iOS: App Store - Publishing changes to expo SDK

#### Setup

Additionally to the global setup you will need to install [fastlane](https://github.com/fastlane/fastlane). Which handles uploading the build file to iTunes Connect for the App Store. You will also need an Apple Developer subscription and have setup an app and bits on iTunes connect.

Create a ./.env based off ./.env.sample and add your own values. Can't remember where you find APPLE_TEAM_ID and FASTLANE_TEAM_ID or why they are different values. Will update this when I find out.

If you have not run either of these builds before it is worth doing the steps manually first, as expo and fastlane will prompt you for some info, which as of yet I can't get it all to work in non-interactive mode based of .env variables :(
These are the steps to run manually if you need to:

```
# This may ask whether you want expo to handle certificates
# and push notifications. Say yes
yarn build:ios

# Keep running this until the build url shows
yarn build:status

# Download the build to ./tmp/build.ipa

# May ask for your apple password to login to iTunes Connect
# Replace APPLE_ID and FASTLANE_TEAM_ID
fastlane pilot upload -u APPLE_ID -q FASTLANE_TEAM_ID -i ./tmp/build.ipa
```

If you have problems running the build scripts, you many need to run the manual steps again to update credentials.

```
yarn publish:appstore
```

### Android: Google Play - Publishing changes to expo SDK

#### Setup

If you have not run either of these builds before it is worth doing the steps manually first, as expo will prompt you for some info, which as of yet I can't get it all to work in non-interactive mode based of .env variables :(
These are the steps to run manually if you need to:

```
# This may ask whether you want expo to handle certificates
# and push notifications. Say yes
yarn build:android

# Keep running this until the build url shows
yarn build:status

# Download the build to ./tmp/build.apk
```

If you have problems running the build scripts, you many need to run the manual steps again to update credentials.

```
yarn publish:googleplay
```

#### Testing APK on an Android device

Connect your android device by USB and enable USB for file transfer.

You may need to download: https://www.android.com/filetransfer/

Drag the .apk file into your device. From the device find the file and tap on install. Easy as pie.

#### Next steps

There's only so much we can automate/have found out how to automate. When the build is successfully downloaded, you then need to upload it to Google Play and fill in all the required details.

### Ejecting from Create React Native App

If you want to build and deploy your app yourself, you'll need to eject from CRNA and use Xcode and Android Studio.

This is usually as simple as running `yarn run eject` in your project, which will walk you through the process. Make sure to install `react-native-cli` and follow the [native code getting started guide for React Native](https://facebook.github.io/react-native/docs/getting-started.html).

#### Should I Use ExpoKit?

If you have made use of Expo APIs while working on your project, then those API calls will stop working if you eject to a regular React Native project. If you want to continue using those APIs, you can eject to "React Native + ExpoKit" which will still allow you to build your own native code and continue using the Expo APIs. See the [ejecting guide](https://github.com/react-community/create-react-native-app/blob/master/EJECTING.md) for more details about this option.

## Troubleshooting

### Networking

If you're unable to load your app on your phone due to a network timeout or a refused connection, a good first step is to verify that your phone and computer are on the same network and that they can reach each other. Create React Native App needs access to ports 19000 and 19001 so ensure that your network and firewall settings allow access from your device to your computer on both of these ports.

Try opening a web browser on your phone and opening the URL that the packager script prints, replacing `exp://` with `http://`. So, for example, if underneath the QR code in your terminal you see:

```
exp://192.168.0.1:19000
```

Try opening Safari or Chrome on your phone and loading

```
http://192.168.0.1:19000
```

and

```
http://192.168.0.1:19001
```

If this works, but you're still unable to load your app by scanning the QR code, please open an issue on the [Create React Native App repository](https://github.com/react-community/create-react-native-app) with details about these steps and any other error messages you may have received.

If you're not able to load the `http` URL in your phone's web browser, try using the tethering/mobile hotspot feature on your phone (beware of data usage, though), connecting your computer to that WiFi network, and restarting the packager.

### iOS Simulator won't open

If you're on a Mac, there are a few errors that users sometimes see when attempting to `yarn run ios`:

* "non-zero exit code: 107"
* "You may need to install Xcode" but it is already installed
* and others

There are a few steps you may want to take to troubleshoot these kinds of errors:

1. Make sure Xcode is installed and open it to accept the license agreement if it prompts you. You can install it from the Mac App Store.
2. Open Xcode's Preferences, the Locations tab, and make sure that the `Command Line Tools` menu option is set to something. Sometimes when the CLI tools are first installed by Homebrew this option is left blank, which can prevent Apple utilities from finding the simulator. Make sure to re-run `yarn run ios` after doing so.
3. If that doesn't work, open the Simulator, and under the app menu select `Reset Contents and Settings...`. After that has finished, quit the Simulator, and re-run `yarn run ios`.

### QR Code does not scan

If you're not able to scan the QR code, make sure your phone's camera is focusing correctly, and also make sure that the contrast on the two colors in your terminal is high enough. For example, WebStorm's default themes may [not have enough contrast](https://github.com/react-community/create-react-native-app/issues/49) for terminal QR codes to be scannable with the system barcode scanners that the Expo app uses.

If this causes problems for you, you may want to try changing your terminal's color theme to have more contrast, or running Create React Native App from a different terminal. You can also manually enter the URL printed by the packager script in the Expo app's search bar to load it manually.
